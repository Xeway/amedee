{{ define "map.html" }}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amedee - Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
        crossorigin integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <style>
    /* Use Flexbox to create a layout with a header and a map that fills the remaining space */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* Prevent scrollbars from appearing */
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* The map container will grow to fill all available vertical space */
    #map-container {
      flex-grow: 1;
      /* We need a container for the map so it knows its height */
    }

    #mapid {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <!-- Bootstrap Navbar for Filters -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Amedee</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#filterNavbar" aria-controls="filterNavbar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="filterNavbar">
        <!-- Use a form for better structure and alignment -->
        <form class="ms-auto d-flex flex-wrap align-items-center">
          <div class="me-2 my-1">
            <label for="startDate" class="visually-hidden">Start Date</label>
            <input type="date" class="form-control form-control-sm" id="startDate" name="startDate" title="Date of arrival">
          </div>
          <div class="me-2 my-1">
            <label for="endDate" class="visually-hidden">End Date</label>
            <input type="date" class="form-control form-control-sm" id="endDate" name="endDate" title="Date of departure">
          </div>
          <div class="me-2 my-1">
            <label for="numPeople" class="visually-hidden">Number of People</label>
            <input type="number" class="form-control form-control-sm" id="numPeople" name="numPeople" placeholder="Number of guests" min="1" step="1" style="width: 100px;">
          </div>
          <button id="filterButton" type="button" class="btn btn-primary btn-sm my-1">Filter Huts</button>
        </form>
      </div>
    </div>
  </nav>

  <!-- We wrap the map in a container to help with the flexbox layout -->
  <div id="map-container">
    <div id="mapid"></div>
  </div>

  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="errorModalLabel">An Error Occurred</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="errorModalBody">
          <!-- Error message will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include Leaflet and Leaflet.TileLayer.Swiss JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
          crossorigin integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-tilelayer-swiss@2.4.0/dist/Leaflet.TileLayer.Swiss.umd.js"
          crossorigin integrity="sha384-Euk+jolNu4/WKjgaLQzvOYEpbiH0yAN0sErw27A95bn2MnIB1I52o9twSk23yZyL">
  </script>

  <!-- Include Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

  <script>
    // Create map and attach id to element with id "mapid"
    var map = L.map('mapid', {
      // Use LV95 (EPSG:2056) projection
      crs: L.CRS.EPSG2056,
    });

    // Add Swiss layer with default options
    L.tileLayer.swiss().addTo(map);

    // Center the map on Switzerland
    map.fitSwitzerland();

    var markerGroup = L.layerGroup().addTo(map);

    const errorModalElement = document.getElementById('errorModal');
    const errorModal = new bootstrap.Modal(errorModalElement);

    document.getElementById('filterButton').addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const numPeople = document.getElementById('numPeople').value;
      const filterButton = document.getElementById('filterButton');

      // Add a loading state to the button
      filterButton.disabled = true;
      filterButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

      fetch('/huts?' + new URLSearchParams({
        startDate: startDate,
        endDate: endDate,
        numPeople: numPeople
      }).toString())
      .then(response => {
        if (!response.ok) { throw new Error('Network response was not ok'); }
        return response.json();
      })
      .then(huts => {
        markerGroup.clearLayers();

        huts.forEach(hut => {
          if (hut.coordinates) {
            const parts = hut.coordinates.split(/[,/]+/).map(c => parseFloat(c.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              const [lat, lon] = parts;
              const greenIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
              });
              const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
              });
              L.marker([lat, lon], {icon: hut.isAvailable ? greenIcon : redIcon}).bindPopup(hut.hutName).addTo(markerGroup);
            } else {
              console.error(`Invalid coordinates for hut ${hut.hutName}: ${hut.coordinates}`);
            }
          } else {
            console.error(`No coordinates for hut ${hut.hutName}`);
          }
        });
      })
      .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
        document.getElementById('errorModalBody').textContent = `Failed to load hut data. Please try again. Details: ${error.message}`;
        errorModal.show();
      })
      .finally(() => {
          // Reset button state after fetch is complete
          filterButton.disabled = false;
          filterButton.textContent = 'Filter Huts';
      });
    });
  </script>
</body>
</html>
{{ end }}
